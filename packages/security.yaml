homeassistant:
    customize_glob:
      "binary_sensor.garage_door_*":
        device_class: opening


camera:
  - platform: local_file
    name: Latest Doorbell 
    file_path: /config/www/cameras/doorbell.jpg
  - platform: local_file
    name: Latest Mailbox 
    file_path: /config/www/cameras/mailbox.jpg


cover:
  - platform: template
    covers:

        garage_door_1:
            device_class: garage
            unique_id: "garage_door_1"
            value_template: "{{ is_state('binary_sensor.garage_door_1', 'on') }}"
            open_cover:
                service: switch.turn_on
                entity_id: switch.garage_door_1
            close_cover:
                service: switch.turn_on
                entity_id: switch.garage_door_1
            stop_cover:
                service: switch.turn_on
                entity_id: switch.garage_door_1

        garage_door_2:
            device_class: garage
            unique_id: "garage_door_2"
            value_template: "{{ is_state('binary_sensor.garage_door_2', 'on') }}"
            open_cover:
                service: switch.turn_on
                entity_id: switch.garage_door_2
            close_cover:
                service: switch.turn_on
                entity_id: switch.garage_door_2
            stop_cover:
                service: switch.turn_on
                entity_id: switch.garage_door_2

        garage_door_3:
            device_class: garage
            unique_id: "garage_door_3"
            value_template: "{{ is_state('binary_sensor.garage_door_3', 'on') }}"
            open_cover:
                service: switch.turn_on
                entity_id: switch.garage_door_3
            close_cover:
                service: switch.turn_on
                entity_id: switch.garage_door_3
            stop_cover:
                service: switch.turn_on
                entity_id: switch.garage_door_3


automation:
  - alias: Security - Status alerts
    initial_state: True
    trigger:
      - platform: state
        entity_id: alarm_control_panel.abode_alarm
        to: "armed_home"
        variables:
          target: "master_bedroom"
      - platform: state
        entity_id: alarm_control_panel.abode_alarm
        to: "disarmed"
        variables:
          target: "master_bedroom"
      - platform: state
        entity_id: alarm_control_panel.abode_alarm
        to: "armed_away"
        variables:
          target: "phones"

    condition:
      # Explicitly call out trigger states and this condition to protect against errors
      condition: template
      value_template: "{{ trigger.from_state.state != 'unavailable' }}"
    action:
      - service: notify.{{ target }}
        data_template:
          message: >
            {% set status = trigger.to_state.state %}

            {%- if status == "disarmed" -%}
              Alarm off
            {%- else -%}
              {%- if status == "armed_home" -%}
                Alarm armed...
              {%- endif -%}

              {%- if is_state("binary_sensor.doors_and_windows_and_garages", "on") -%}
                Warning! The following are open: {{ expand("binary_sensor.doors_and_windows_and_garages") | selectattr("state", "eq", "on") | map(attribute="name") | join(", ") }}
              {%- endif -%}
            {%- endif -%}

  - alias: Security - Turn house off
    initial_state: True
    trigger:
      platform: state
      entity_id: alarm_control_panel.abode_alarm
      to: "armed_away"
    action:
      - service: scene.turn_on
        data:
          entity_id: scene.house_off

  - alias: Security - Alert lighting
    initial_state: True
    trigger:
      platform: event
      event_type: abode_alarm
    action:
      - service: scene.turn_on
        data:
          entity_id: scene.house_alert

  - alias: Security - Alert
    initial_state: True
    trigger:
      platform: event
      event_type: abode_alarm
    action:
      - service: notify.phones
        data_template:
          title: "Home"
          message: "Alarm alert!"
          data:
            entity_id: camera.front_door
            url: "/lovelace/cameras"
            push:
              sound:
                name: "default"
                critical: 1
                volume: 1
      - service: system_log.write
        data_template:
          message: "Alarm: {{ trigger.event.data }}"
          level: error

  - alias: Security - Fault
    initial_state: True
    trigger:
      - platform: event
        event_type: abode_panel_fault
      - platform: event
        event_type: abode_panel_restore
    action:
      - service: notify.phones
        data:
          title: "Home"
          message: "Alarm Fault {{ trigger.event.data.event_name }}"
          data:
            url: "/config/logs"
      - service: system_log.write
        data_template:
          message: "Alarm Fault {{ trigger.event.data }}"
          level: error

  - alias: Security - Doorbell notifications
    initial_state: True
    trigger:
      platform: state
      entity_id: binary_sensor.doorbell_sensor
      to: "on"
    action:
      - service: camera.snapshot
        data:
          entity_id: camera.front_door
          filename: "/config/www/cameras/doorbell.jpg"
      - service: notify.phones
        data_template:
          title: "Home"
          message: "Doorbell"
          data:
            entity_id: camera.front_door
            url: "/lovelace/cameras"
      - delay:
          minutes: 1

  - alias: Security - Garage door open
    initial_state: True
    trigger:
      platform: state
      entity_id:
        - binary_sensor.garage_door_1
        - binary_sensor.garage_door_2
        - binary_sensor.garage_door_3
      to: "on"
      for:
        minutes: 10
    mode: parallel
    action:
      - service: notify.phones
        data_template:
          title: "Home"
          message: "{{ trigger.to_state.attributes.friendly_name }} was left open"

  - alias: Security - Mailbox open
    initial_state: True
    mode: single
    trigger:
      - platform: state
        entity_id: binary_sensor.mailbox_motion
        to: "on"
    action:
      - service: camera.snapshot
        data:
          entity_id: camera.driveway
          filename: "/config/www/cameras/mailbox.jpg"
      - service: notify.phones
        data_template:
          title: "Home"
          message: "Mailbox motion detected!"
          data:
            url: "/lovelace/cameras"
            push:
              sound:
                name: "default"
                critical: "{{ (states('sun.sun') == 'below_horizon')|int }}"
                volume: "{{ (states('sun.sun') == 'below_horizon')|int }}"
      - service: system_log.write
        data_template:
          message: "Mailbox motion detected"
          level: info
      - delay:
          minutes: 1
